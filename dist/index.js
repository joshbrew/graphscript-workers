(()=>{var __require=(x3=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(x3,{get:(a,b3)=>(typeof require!=="undefined"?require:a)[b3]}):x3)(function(x3){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+x3+'" is not supported')});var x=class{data={};triggers={};ctr=0;constructor(e){typeof e=="object"&&(this.data=e)}setState=e=>{Object.assign(this.data,e);let t=Object.getOwnPropertyNames(e);for(let n of t)this.triggerEvent(n,this.data[n]);if(this.triggers[G]){let n=r=>{r(e)},s=this.triggers[G].length;for(let r=s-1;r>=0;r--)n(this.triggers[G][r].onchange)}return this.data};setValue=(e,t)=>{this.data[e]=t,this.triggerEvent(e,t)};triggerEvent=(e,t)=>{if(this.triggers[e]){let n=r=>{r.onchange(t)},s=this.triggers[e].length;for(let r=s-1;r>=0;r--)n(this.triggers[e][r])}};subscribeState=e=>this.subscribeEvent(G,e);unsubscribeState=e=>this.unsubscribeEvent(G,e);subscribeEvent=(e,t,n,s)=>{if(e){n&&s&&!this.triggers[e]&&Object.defineProperty(this.data,e,{get:()=>n[s],set:_2=>{n[s]=_2},enumerable:true,configurable:true}),this.triggers[e]||(this.triggers[e]=[]);let r=this.ctr;return this.ctr++,this.triggers[e].push({sub:r,onchange:t}),r}else return};unsubscribeEvent=(e,t)=>{let n=this.triggers[e];if(n)if(t===void 0)delete this.triggers[e],delete this.data[e];else{let s,r=n.find((_2,o)=>{if(_2.sub===t)return s=o,true});return r&&n.splice(s,1),Object.keys(n).length===0&&(delete this.triggers[e],delete this.data[e]),this.onRemoved&&this.onRemoved(r),true}};subscribeEventOnce=(e,t)=>{let n,s=r=>{t(r),this.unsubscribeEvent(e,n)};return n=this.subscribeEvent(e,s),n};getEvent=(e,t)=>{if(typeof t!="number")return this.triggers[e];for(let n in this.triggers[e])if(this.triggers[e][n].sub===t)return this.triggers[e][n]};getSnapshot=()=>{let e={};for(let t in this.data)e[t]=this.data[t]};onRemoved};var G="*s";var q=new x;var w=class extends Function{__bound;__call;constructor(){return super("return this.__bound.__call.apply(this.__bound, arguments)"),this.__bound=this.bind(this),this.__bound}};var y=class i{__node={tag:`node${Math.floor(Math.random()*1e15)}`,unique:`${Math.floor(Math.random()*1e15)}`,state:q};__children;__parent;__operator;__listeners;__props;__args;constructor(e,t,n){if(this.__setProperties(e,t,n),typeof e=="function"||e?.__callable){let s=new w;s.__call=(..._2)=>this.__operator(..._2);let r=new Proxy(s,{get:(_2,o,a)=>Reflect.has(this,o)?Reflect.get(this,o,a):Reflect.get(_2,o,a),set:(_2,o,a,f2)=>Reflect.has(this,o)?Reflect.set(this,o,a,f2):Reflect.set(_2,o,a,f2)});return Object.setPrototypeOf(r,this),r}}get __graph(){return this.__node?.graph}set __graph(e){this.__node.graph=e}__setProperties=(e,t,n)=>{if((()=>{let r=e;typeof e=="function"?S(e)?e=new e:e={__operator:e,__node:{forward:true,tag:e.name}}:typeof e=="string"&&n?.get(e)&&(e=n.get(e)),"__node"in e||(e.__node={}),e.__node.initial||(e.__node.initial=r)})(),typeof e=="object"){let r=()=>{e.__node?.state?this.__node.state=e.__node.state:n&&(e.__node.state=n.__node.state)},_2=()=>{e.__props&&(typeof e.__props=="function"&&(e.__props=new e.__props),typeof e.__props=="object"&&this.__proxyObject(e.__props))},o=()=>{e.__node.tag||(e.__operator?.name?e.__node.tag=e.__operator.name:e.__node.tag=`node${Math.floor(Math.random()*1e15)}`)},a=()=>{typeof e.__node=="string"?n?.get(e.__node.tag)?e=n.get(e.__node.tag):e.__node={}:e.__node||(e.__node={}),n&&(e.__node.graph=n),e instanceof b&&(e.__node.source=e)},f2=()=>{if(!e.__parent&&t&&(e.__parent=t),t?.__node&&!(t instanceof b||e instanceof b)&&(e.__node.tag=t.__node.tag+"."+e.__node.tag),t instanceof b&&e instanceof b&&(e.__node.loaders&&Object.assign(t.__node.loaders?t.__node.loaders:{},e.__node.loaders),t.__node.mapGraphs)){e.__node.nodes.forEach(h2=>{t.set(e.__node.tag+"."+h2.__node.tag,h2)});let u=()=>{e.__node.nodes.forEach(h2=>{t.__node.nodes.delete(e.__node.tag+"."+h2.__node.tag)})};this.__addOndisconnected(u)}},l=()=>{if(typeof e.default=="function"&&!e.__operator&&(e.__operator=e.default),e.__operator){if(typeof e.__operator=="string"&&n){let u=n.get(e.__operator);u&&(e.__operator=u.__operator),!e.__node.tag&&e.__operator.name&&(e.__node.tag=e.__operator.name)}typeof e.__operator=="function"&&(e.__operator=this.__setOperator(e.__operator)),e.default&&(e.default=e.__operator)}},c2=()=>{e.__node=Object.assign(this.__node,e.__node);let u=Object.getOwnPropertyNames(e).filter(h2=>{if(!O[h2])return true});for(let h2 of u)h2 in e&&h2!=="name"&&(this[h2]=e[h2])},d2=()=>{this.__onconnected&&(typeof this.__onconnected=="function"?this.__onconnected=this.__onconnected.bind(this):Array.isArray(this.__onconnected)&&(this.__onconnected=this.__onconnected.map(u=>u.bind(this))),typeof this.__ondisconnected=="function"?this.__ondisconnected=this.__ondisconnected.bind(this):Array.isArray(this.__ondisconnected)&&(this.__ondisconnected=this.__ondisconnected.map(u=>u.bind(this))))};r(),o(),_2(),a(),f2(),c2(),d2(),l()}};__subscribe=(e,t,n,s,r,_2,o)=>{let a=(l,c2=(u,h2)=>h2||u,d2=e)=>{let u;if(_2){let p2=j(d2,_2,this.__node.graph);d2=p2.__callback,u=p2.__args}let h2=this.__node.state.subscribeEvent(l,d2,this,t),g2=this.__node.state.getEvent(l,h2);return this.__listeners||(this.__listeners={}),this.__listeners[l]=this.__node.state.triggers[l],g2&&(g2.source=this.__node.tag,t&&(g2.key=t),g2.target=c2(e,s),r&&(g2.tkey=r),n&&(g2.subInput=n),_2&&(g2.arguments=u,g2.__args=_2),o&&(g2.__callback=o),g2.node=this,g2.graph=this.__node.graph),h2},f2=l=>{let c2=this.__node.graph.get(l);if(!c2&&l.includes(".")){s=l.substring(0,l.lastIndexOf("."));let d2=this.__node.graph.get(l.substring(0,s));r=l.lastIndexOf(".")+1,d2&&typeof d2[t]=="function"&&(l=(...u)=>d2[r](...u))}else c2.__operator&&(l=c2.__operator,r="__operator");return l};if(t){if((!this.__node.localState||!this.__node.localState[t])&&this.__addLocalState(this,t),typeof e=="string"){if(o=this.__node.tag+"."+e,r=e,s){if(this.__node.graph?.get(s)){let d2=this.__node.graph?.get(s);if(typeof d2[e]=="function"){let u=d2[e];e=(...h2)=>{u(...h2)}}else{let u=e;e=g2=>{d2[u]=g2}}}}else if(typeof this[e]=="function"){let d2=this[e];e=(...u)=>{d2(...u)}}else this.__node.graph?.get(e)&&(e=f2(e));if(typeof e!="function")return}let l,c2=n?this.__node.unique+"."+t+"input":this.__node.unique+"."+t;return typeof e=="function"&&!e?.__node?l=a(c2,(d2,u)=>u||d2,e):e?.__node&&(l=a(c2,(d2,u)=>u||d2.__node.unique,(...d2)=>{e.__operator&&e.__operator(...d2)})),l}else{if(typeof e=="string"&&(o=e,s||(s=e),this.__node.graph.get(e)&&(e=this.__node.graph.get(e)),r="__operator",typeof e!="object"))return;let l,c2=n?this.__node.unique+"input":this.__node.unique;return typeof e=="function"&&!e?.__node?l=a(c2,(d2,u)=>u||d2,e):e?.__node&&(l=a(c2,(d2,u)=>u||d2.__node.unique,(...d2)=>{e.__operator&&e.__operator(...d2)})),l}};__unsubscribe=(e,t,n)=>t?this.__node.state.unsubscribeEvent(n?this.__node.unique+"."+t+"input":this.__node.unique+"."+t,e):this.__node.state.unsubscribeEvent(n?this.__node.unique+"input":this.__node.unique,e);__setOperator=e=>{e=e.bind(this),this.__args&&this.__node.graph&&(e=j(e,this.__args,this.__node.graph).__callback);let t=`${this.__node.unique}input`;if(this.__operator=(...n)=>{this.__node.state.triggers[t]&&this.__node.state.setValue(t,n);let s=e(...n);return this.__node.state.triggers[this.__node.unique]&&(typeof s?.then=="function"?s.then(r=>{r!==void 0&&this.__node.state.setValue(this.__node.unique,r)}).catch(console.error):s!==void 0&&this.__node.state.setValue(this.__node.unique,s)),s},this.__parent instanceof i&&!this.__subscribedToParent&&this.__parent.__operator){let n=this.__parent.__subscribe(this),s=()=>{this.__parent?.__unsubscribe(n),delete this.__subscribedToParent};this.__addOndisconnected(s),this.__subscribedToParent=true}return this.__operator};__addLocalState=(e,t)=>{if(!e)return;this.__node.localState||(this.__node.localState={});let n=this.__node.localState,s=(r,_2)=>{let o=this.__node.unique+"."+_2,a=`${o}input`,f2,l,c2,d2;if(typeof r[_2]=="function"&&_2!=="__operator")this.__props?.[_2]?c2=this.__props:c2=n,f2=()=>c2[_2],l=u=>{this.__props?.[_2]||(u=u.bind(this)),c2[_2]=(...h2)=>{this.__node.state.triggers[a]&&this.__node.state.setValue(a,h2);let g2=u(...h2);return this.__node.state.triggers[o]&&(typeof g2?.then=="function"?g2.then(p2=>{this.__node.state.triggerEvent(o,p2)}).catch(console.error):this.__node.state.triggerEvent(o,g2)),g2}},n[_2]=r[_2].bind(this),d2={get:f2,set:l,enumerable:true,configurable:true};else if(_2!=="__graph"){let u,h2,g2;this.__props?.[_2]?g2=this.__props:g2=n,u=()=>g2[_2],h2=p2=>{g2[_2]=p2,this.__node.state.triggers[o]&&this.__node.state.triggerEvent(o,p2)},n[_2]=r[_2],d2={get:u,set:h2,enumerable:true,configurable:true}}if(Object.defineProperty(r,_2,d2),typeof this.__node.initial=="object"){let u=Object.getOwnPropertyDescriptor(this.__node.initial,_2);(u===void 0||u?.configurable)&&Object.defineProperty(this.__node.initial,_2,d2)}};if(t)s(e,t);else for(let r in e)s(e,r)};__proxyObject=e=>{let t=I(e);for(let n of t){let s={get:()=>e[n],set:r=>{e[n]=r},enumerable:true,configurable:true};if(Object.defineProperty(this,n,s),typeof this.__node.initial=="object"){let r=Object.getOwnPropertyDescriptor(this.__node.initial,n);(r===void 0||r?.configurable)&&Object.defineProperty(this.__node.initial,n,s)}}};__addOnconnected(e){e=e.bind(this),Array.isArray(this.__onconnected)?this.__onconnected.push(e):typeof this.__onconnected=="function"?this.__onconnected=[e,this.__onconnected]:this.__onconnected=e}__addOndisconnected(e){e=e.bind(this),Array.isArray(this.__ondisconnected)?this.__ondisconnected.push(e):typeof this.__ondisconnected=="function"?this.__ondisconnected=[e,this.__ondisconnected]:this.__ondisconnected=e}__callConnected(e=this){if(typeof this.__onconnected=="function")this.__onconnected(this);else if(Array.isArray(this.__onconnected)){let t=n=>{n(this)};this.__onconnected.forEach(t)}}__callDisconnected(e=this){if(typeof this.__ondisconnected=="function")this.__ondisconnected(this);else if(Array.isArray(this.__ondisconnected)){let t=n=>{n(this)};this.__ondisconnected.forEach(t)}}};var b=class i2{__node={tag:`graph${Math.floor(Math.random()*1e15)}`,unique:`${Math.random()}`,nodes:new Map,state:q,roots:{}};constructor(e){this.init(e)}init=e=>{if(e){let t=Object.assign({},e);delete t.roots,N(this.__node,t),e.roots&&this.load(e.roots)}};load=(e,t=false)=>{function n(_2,o,a=true,f2=true){if(f2){_2||(_2={});for(let l in o)!l.startsWith("__")&&o[l]&&typeof o[l]=="object"?(_2[l]=o[l],o[l]?.__children&&n({},o[l].__children,false,false)):typeof o[l]=="function"&&(_2[l]=o[l]);n(_2,o,true,false)}else if(o?.__children&&!a)o.__children?.constructor.name==="Object"?_2.__children?.constructor.name==="Object"?_2.__children=n(_2.__children,o.__children,true,false):_2.__children=n({},o.__children,true,false):_2.__children=o.__children;else if(a)for(let l in o)!l.startsWith("__")&&o[l]&&typeof o[l]=="object"?(_2[l]=Object.assign({},o[l]),o[l]?.__children&&(_2[l].__children=n({},o[l].__children,false,false))):typeof o[l]=="function"&&(_2[l]=o[l]);return _2}this.__node.roots=n(this.__node.roots?this.__node.roots:{},e);let s=Object.assign({},e);s.__node&&delete s.__node;let r=this.recursiveSet(s,this,void 0,e,t);if(e.__node){if(!e.__node.tag)e.__node._tag=`roots${Math.floor(Math.random()*1e15)}`;else if(!this.get(e.__node.tag)){let _2=new y(e,this,this);this.set(_2.__node.tag,_2),this.runLoaders(_2,this,e,e.__node.tag),_2.__listeners&&(r[_2.__node.tag]=_2.__listeners)}}else e.__listeners&&this.setListeners(e.__listeners);return this.setListeners(r),s};setLoaders=(e,t)=>(t?this.__node.loaders=e:Object.assign(this.__node.loaders,e),this.__node.loaders);runLoaders=(e,t,n,s)=>{for(let r in this.__node.loaders)typeof this.__node.loaders[r]=="object"?(this.__node.loaders[r].init&&this.__node.loaders[r](e,t,this,this.__node.roots,n,s),this.__node.loaders[r].connected&&e.__addOnconnected(this.__node.loaders[r].connect),this.__node.loaders[r].disconnected&&e.__addOndisconnected(this.__node.loaders[r].disconnect)):typeof this.__node.loaders[r]=="function"&&this.__node.loaders[r](e,t,this,this.__node.roots,n,s)};add=(e,t,n=true)=>{let s={};typeof t=="string"&&(t=this.get(t));let r;if(typeof e=="function"?S(e)?e.prototype instanceof y?(e=e.prototype.constructor(e,t,this),r=true):e=new e:e={__operator:e,__callable:true}:typeof e=="string"&&(e=this.__node.roots[e]),!e)return;if(!r){let a=Object.getOwnPropertyNames(e),f2=Object.getOwnPropertyNames(Object.getPrototypeOf(e));a.push(...f2),a=a.filter(c2=>!O.includes(c2));let l={};for(let c2 of a)l[c2]=e[c2];e=l}if(e.__node||(e.__node={}),e.__node.initial=e,typeof e=="object"&&this.get(e.__node.tag))if(n)this.remove(e.__node.tag,true);else return;else if(e.__node.tag&&this.get(e.__node.tag))return this.get(e.__node.tag);let _2,o=N({},e,2);if(r?_2=e:_2=new y(e,t,this),this.set(_2.__node.tag,_2),this.runLoaders(_2,t,e,_2.__node.tag),this.__node.roots[_2.__node.tag]=o,_2.__children&&(_2.__children=Object.assign({},_2.__children),this.recursiveSet(_2.__children,_2,s,_2.__children)),_2.__listeners){s[_2.__node.tag]=Object.assign({},_2.__listeners);for(let a in _2.__listeners){let f2=_2.__listeners[a];_2[a]&&(delete s[_2.__node.tag][a],s[_2.__node.tag][_2.__node.tag+"."+a]=f2),typeof f2=="string"&&(_2.__children?.[f2]?s[_2.__node.tag][a]=_2.__node.tag+"."+f2:t instanceof y&&(t.__node.tag===f2||t.__node.tag.includes(".")&&t.__node.tag.split(".").pop()===f2)&&(s[_2.__node.tag][a]=t.__node.tag))}}return this.setListeners(s),_2.__callConnected(),_2};recursiveSet=(e,t,n={},s,r=false)=>{let _2=Object.getOwnPropertyNames(s).filter(a=>!O.includes(a)),o=Object.getOwnPropertyNames(Object.getPrototypeOf(s)).filter(a=>!O.includes(a));_2.push(...o);for(let a of _2){if(a.includes("__"))continue;let f2=s[a];if(Array.isArray(f2))continue;let l;if(typeof f2=="function"?S(f2)?(f2=new f2,f2 instanceof y&&(f2=f2.prototype.constructor(f2,t,this),l=true)):f2={__operator:f2,__callable:true}:typeof f2=="string"?this.__node.nodes.get(f2)?f2=this.__node.nodes.get(f2):f2=this.__node.roots[f2]:typeof f2=="boolean"&&(this.__node.nodes.get(a)?f2=this.__node.nodes.get(a):f2=this.__node.roots[a]),f2&&typeof f2=="object"){if(!l&&!(f2 instanceof y)){let h2=Object.getOwnPropertyNames(f2).filter(m2=>!O.includes(m2)),g2=Object.getOwnPropertyNames(Object.getPrototypeOf(f2)).filter(m2=>!O.includes(m2));g2.splice(g2.indexOf("constructor"),1),h2.push(...g2);let p2={};for(let m2 of h2)p2[m2]=f2[m2];f2=p2}if(f2.__node||(f2.__node={}),f2.__node.tag||(f2.__node.tag=a),f2.__node.initial||(f2.__node.initial=e[a]),r&&this.get(f2.__node.tag))this.remove(f2.__node.tag,true);else if(this.get(f2.__node.tag)&&!(!(t instanceof i2)&&t?.__node)||t?.__node&&this.get(t.__node.tag+"."+f2.__node.tag))continue;let c2,d2=false,u=N({},f2,2);if(l||f2 instanceof y?c2=f2:(c2=new y(f2,t,this),d2=true),!d2&&f2 instanceof y&&!l&&t instanceof y){let h2=this.subscribe(t.__node.tag,c2.__node.tag),g2=p2=>{this.unsubscribe(t.__node.tag,h2)};c2.__addOndisconnected(g2)}else if(c2){if(this.set(c2.__node.tag,c2),this.runLoaders(c2,t,e[a],a),e[a]=c2,this.__node.roots[c2.__node.tag]=u,c2.__children&&(c2.__children=Object.assign({},c2.__children),this.recursiveSet(c2.__children,c2,n,c2.__children)),c2.__listeners){n[c2.__node.tag]=Object.assign({},c2.__listeners);for(let h2 in c2.__listeners){let g2=c2.__listeners[h2],p2=h2;c2[h2]&&(delete n[c2.__node.tag][h2],p2=c2.__node.tag+"."+h2,n[c2.__node.tag][p2]=g2),typeof g2=="string"&&(c2.__children?.[g2]?n[c2.__node.tag][p2]=c2.__node.tag+"."+g2:t instanceof y&&(t.__node.tag===g2||t.__node.tag.includes(".")&&t.__node.tag.split(".").pop()===g2)&&(n[c2.__node.tag][p2]=t.__node.tag))}}c2.__callConnected()}}}return n};remove=(e,t=true)=>{if(this.unsubscribe(e),typeof e=="string"&&(e=this.get(e)),e instanceof y){this.delete(e.__node.tag),delete this.__node.roots[e.__node.tag],t&&this.clearListeners(e),e.__callDisconnected();let n=s=>{for(let r in s)this.unsubscribe(s[r]),this.delete(s[r].__node.tag),delete this.__node.roots[s[r].__node.tag],this.delete(r),delete this.__node.roots[r],s[r].__node.tag=s[r].__node.tag.substring(s[r].__node.tag.lastIndexOf(".")+1),t&&this.clearListeners(s[r]),s[r].__callDisconnected(),s[r].__children&&n(s[r].__children)};e.__children&&n(e.__children)}return e?.__node.tag&&e?.__parent&&(delete e?.__parent,e.__node.tag=e.__node.tag.substring(e.__node.tag.indexOf(".")+1)),e?.__node.graph&&(e.__node.graph=void 0),e};run=(e,...t)=>{if(typeof e=="string"){let n=this.get(e);if(!n&&e.includes(".")){if(n=this.get(e.substring(0,e.lastIndexOf("."))),typeof n?.[e.substring(e.lastIndexOf(".")+1)]=="function")return n[e.substring(e.lastIndexOf(".")+1)](...t)}else if(n?.__operator)return n.__operator(...t)}if(e?.__operator)return e?.__operator(...t)};setListeners=e=>{for(let t in e){let n=this.get(t);if(typeof e[t]=="object")for(let s in e[t]){let r=this.get(s),_2;if(typeof e[t][s]!="object")e[t][s]={__callback:e[t][s]};else if(!e[t][s].__callback)for(let o in e[t][s]){typeof e[t][s][o]!="object"&&(e[t][s][o]={__callback:e[t][s][o]},n.__operator&&(e[t][s][o].__callback===true||typeof e[t][s][o].__callback>"u")&&(e[t][s][o].__callback=n.__operator));let a=this.get(o);if(a)_2=this.subscribe(a,e[t][s][o].__callback,e[t][s][o].__args,void 0,e[t][s][o].subInput,t);else{let f2=s.substring(0,s.lastIndexOf("."));if(a=this.get(f2),a){let l=s.substring(s.lastIndexOf(".")+1);_2=this.subscribe(a,e[t][s][o].__callback,e[t][s][o].__args,l,e[t][s][o].subInput,t)}}}if("__callback"in e[t][s])if(n&&((e[t][s].__callback===true||typeof e[t][s].__callback>"u")&&(e[t][s].__callback=n.__operator),typeof e[t][s].__callback=="function"&&(e[t][s].__callback=e[t][s].__callback.bind(n))),r)_2=this.subscribe(r,e[t][s].__callback,e[t][s].__args,void 0,e[t][s].subInput,t);else{let o=s.substring(0,s.lastIndexOf("."));r=this.get(o),r&&(_2=this.subscribe(r,e[t][s].__callback,e[t][s].__args,s.substring(s.lastIndexOf(".")+1),e[t][s].subInput,t))}}}};clearListeners=(e,t)=>{if(typeof e=="string"&&(e=this.get(e)),e?.__listeners)for(let n in e.__listeners){if(t&&n!==t||typeof e.__listeners[n]?.sub!="number")continue;let s=this.get(n);if(s)if(typeof!e.__listeners[n]?.__callback=="number")for(let r in e.__listeners[n])e.__listeners[n][r]?.sub&&(this.unsubscribe(s,e.__listeners[n][r].sub,void 0,e.__listeners[n][r].subInput),e.__listeners[n][r].sub=void 0);else typeof e.__listeners[n]?.sub=="number"&&(this.unsubscribe(s,e.__listeners[n].sub,void 0,e.__listeners[n].subInput),e.__listeners[n].sub=void 0);else if(s=this.get(n.substring(0,n.lastIndexOf("."))),s)if(typeof e.__listeners[n]=="object"&&!e.__listeners[n]?.__callback)for(let r in e.__listeners[n])typeof e.__listeners[n][r]?.sub=="number"&&(this.unsubscribe(s,e.__listeners[n][r].sub,n.substring(n.lastIndexOf(".")+1),e.__listeners[n][r].subInput),e.__listeners[n][r].sub=void 0);else typeof e.__listeners[n]?.sub=="number"&&(this.unsubscribe(s,e.__listeners[n].sub,n.substring(n.lastIndexOf(".")+1),e.__listeners[n].subInput),e.__listeners[n].sub=void 0)}};get=e=>this.__node.nodes.get(e);getByUnique=e=>Array.from(this.__node.nodes.values()).find(t=>{if(t.__node.unique===e)return true});set=(e,t)=>this.__node.nodes.set(e,t);delete=e=>this.__node.nodes.delete(e);list=()=>Array.from(this.__node.nodes.keys());getListener=(e,t,n)=>{let s=this.get(e);if(s){let r=s.__node.unique;return t&&(r+="."+t),this.__node.state.getEvent(r,n)}};getProps=(e,t)=>{if(typeof e=="string"&&(e=this.get(e)),e instanceof y){let n;if(t)n=Object.assign({},this.__node.roots[e.__node.tag]);else{n=Object.assign({},e);for(let s in n)s.includes("__")&&delete n[s]}}};subscribe=(e,t,n,s,r,_2,o)=>{let a=e;typeof e=="string"&&(a=this.get(e),!a&&e.includes(".")&&(a=this.get(e.substring(0,e.lastIndexOf("."))),s=e.substring(e.lastIndexOf(".")+1))),_2 instanceof y&&(_2=_2.__node.tag);let f2;if(typeof t=="string"){f2=t;let c2=d2=>{if(this.get(d2)?.__operator){let u=this.get(d2);_2=d2,d2=function(...h2){return u.__operator(...h2)}}else if(d2.includes(".")){_2=d2.substring(0,d2.lastIndexOf("."));let u=this.get(_2),h2=d2.substring(d2.lastIndexOf(".")+1);o=h2,typeof u[h2]=="function"?u[h2]instanceof y?d2=u[h2]:d2=function(...g2){return u[h2](...g2)}:d2=function(g2){return u[h2]=g2,u[h2]}}return d2};if(_2){let d2=this.get(_2);typeof d2?.[t]=="function"?(o=t,t=function(...u){return d2[s](...u)}):d2?.[s]?(o=s,d2[s]instanceof y?t=d2[s]:t=function(u){return d2[s]=u,d2[s]}):t=c2(t)}else t=c2(t)}let l;if(a instanceof y){let c2=()=>{l=a.__subscribe(t,s,r,_2,o,n,f2);let d2=()=>{l!==void 0&&a.__unsubscribe(l,s,r),l=void 0};a.__addOndisconnected(()=>{d2(),a.__addOnconnected(()=>{l===void 0&&a.__node.graph.__node.tag===this.__node.tag&&c2()})}),typeof t=="string"&&this.get(t)&&(t=this.get(t)),t instanceof y&&t.__addOndisconnected(()=>{d2()})};c2()}else if(typeof e=="string"){let c2=this.get(e);if(c2){if(t instanceof y&&t.__operator){let d2=()=>{l=c2.__subscribe(t.__operator,s,r,_2,o,n,f2);let u=()=>{l!==void 0&&c2.__unsubscribe(l,s,r)};c2.__addOndisconnected(()=>{u(),c2.__addOnconnected(()=>{l===void 0&&c2.__node.graph.__node.tag===this.__node.tag&&d2()})}),t.__addOndisconnected(u)};d2()}else if(typeof t=="function"||typeof t=="string"){let d2=()=>{l=c2.__subscribe(t,s,r,_2,o,n,f2);let u=()=>{l!==void 0&&c2.__unsubscribe(l,s,r),l=void 0};c2.__addOndisconnected(()=>{u(),c2.__addOnconnected(()=>{l===void 0&&c2.__node.graph.__node.tag===this.__node.tag&&d2()})}),typeof t=="string"&&this.get(t)&&this.get(t).__addOndisconnected(u)};d2()}}else typeof t=="string"&&(t=this.__node.nodes.get(t).__operator),typeof t=="function"&&!t?.__node&&(l=this.__node.state.subscribeEvent(e,t))}return l};unsubscribe=(e,t,n,s)=>e instanceof y?e.__unsubscribe(t,n,s):this.get(e)?.__unsubscribe(t,n,s);setState=e=>{this.__node.state.setState(e)}};function N(i3,e,t=1/0,n=0){for(let s in e)e[s]?.constructor.name==="Object"&&n<t?(n++,i3[s]?.constructor.name==="Object"?N(i3[s],e[s],t,n):i3[s]=N({},e[s],t,n)):i3[s]=e[s];return i3}function I(i3){var e=[],t=i3;do{var n=Object.getOwnPropertyNames(t);let s=function(r){e.indexOf(r)===-1&&e.push(r)};n.forEach(s)}while(t=Object.getPrototypeOf(t));return e}function S(i3){return R(i3)==="class"}function R(i3){return typeof i3=="function"?i3.prototype?Object.getOwnPropertyDescriptor(i3,"prototype")?.writable?"function":"class":i3.constructor.name==="AsyncFunction"?"async":"arrow":""}var A=(i3,e)=>{if(e.get(i3)?.__operator){let t=e.get(i3);return(...n)=>{t.__operator(...n)}}else if(i3.includes(".")){let t=i3.split("."),n=t.pop(),s=t.join("."),r=e.get(s);return typeof e.get(s)?.[n]=="function"?(..._2)=>r[n](..._2):()=>r[n]}else if(e.get(i3)){let t=e.get(i3);return()=>t}else{let t=i3;return()=>t}};var j=(i3,e,t)=>{let n=[],s=(_2,o)=>{if(_2==="__output"||_2==="__input"||_2==="__callback")n[o]={__callback:a=>a,__args:void 0,idx:o};else if(typeof _2=="string")n[o]={__callback:A(_2,t),__args:void 0,idx:o};else if(typeof _2=="function"){let a=_2;n[o]={__callback:(...f2)=>a(...f2),__args:void 0,idx:o}}else if(typeof _2=="object"&&(_2.__input||_2.__callback)){let a=function(f2){let l=f2.__input?f2.__input:f2.__callback;if(typeof f2.__input=="string"&&(l={__callback:A(f2.__input,t),__args:void 0,idx:o}),f2.__args){let c2=j(l,f2.__args,t);l={__callback:c2.__callback,__args:c2.__args,idx:o}}else l={__callback:l,__args:void 0,idx:o};if(f2.__output){let c2=f2.__output;if(typeof f2.__output=="string"?c2={__callback:A(c2,t),__args:void 0,idx:o}:typeof _2.__output=="object"&&(c2=a(c2)),typeof c2?.__callback=="function"){let d2=l.__callback,u=c2.__callback;l={__callback:(...h2)=>u(d2(...h2)),__args:c2.__args,idx:o}}}return l};n[o]=a(_2)}else{let a=_2;n[o]={__callback:()=>a,__args:void 0,idx:o}}};e.forEach(s),typeof i3=="string"&&(i3={__callback:A(i3,t),__args:void 0});let r=typeof i3=="function"?i3:i3.__callback;return i3=function(..._2){let o=f2=>f2.__callback(..._2);return r(...n.map(o))},{__callback:i3,__args:n}};var O=Object.getOwnPropertyNames(Object.getPrototypeOf({}));var C=(i3,e,t)=>{i3.__node.backward&&e instanceof y&&t.setListeners({[e.__node.tag]:{[i3.__node.tag]:e}})};var T=(i3,e,t)=>{if(i3.__operator){let n=Math.random();if(i3.__node.loops||(i3.__node.loops={}),typeof i3.__node.delay=="number"){let s=i3.__operator;i3.__setOperator((...r)=>new Promise((_2,o)=>{i3.__node.loops[n]=setTimeout(async()=>{_2(await s(...r))},i3.__node.delay)}))}else if(i3.__node.frame===true){let s=i3.__operator;i3.__setOperator((...r)=>new Promise((_2,o)=>{i3.__node.loops[n]=requestAnimationFrame(async()=>{_2(await s(...r))})}))}if(typeof i3.__node.repeat=="number"||typeof i3.__node.recursive=="number"){let s=i3.__operator;i3.__setOperator(async(...r)=>{let _2=i3.__node.repeat?i3.__node.repeat:i3.__node.recursive,o,a=async(f2,...l)=>{for(;f2>0;){if(i3.__node.delay||i3.__node.frame){s(...l).then(async c2=>{i3.__node.recursive?await a(f2,c2):await a(f2,...l)});break}else o=await s(...r);f2--}};return await a(_2,...r),o})}if(i3.__node.loop&&typeof i3.__node.loop=="number"){let s=i3.__operator,r=i3.__node.loop;i3.__setOperator((...o)=>{if("looping"in i3.__node||(i3.__node.looping=true),i3.__node.looping){let a=performance.now();s(...o),i3.__node.loops[n]=setTimeout(()=>{let l=performance.now()-a-i3.__node.loop;l>0?r=i3.__node.loop-l:r=i3.__node.loop,r<=0&&(r=i3.__node.loop),i3.__operator(...o)},r)}}),i3.__node.looping&&i3.__operator();let _2=o=>{o.__node.looping&&(o.__node.looping=false),o.__node.loops[n]&&(clearTimeout(o.__node.loops[n]),cancelAnimationFrame(o.__node.loops[n]))};i3.__addOndisconnected(_2)}}};var $=(i3,e,t)=>{if(i3.__node.animate===true||i3.__animation){let n=i3.__operator;i3.__setOperator((...r)=>{"animating"in i3.__node||(i3.__node.animating=true),i3.__node.animating&&(typeof i3.__animation=="function"?i3.__animation(...r):n(...r),i3.__node.animationFrame=requestAnimationFrame(()=>{i3.__operator(...r)}))}),(i3.__node.animating||(!("animating"in i3.__node)||i3.__node.animating)&&i3.__animation)&&setTimeout(()=>{i3.__node.animationFrame=requestAnimationFrame(i3.__operator)},10);let s=r=>{r.__node.animating&&(r.__node.animating=false),r.__node.animationFrame&&cancelAnimationFrame(r.__node.animationFrame)};i3.__addOndisconnected(s)}};var J=(i3,e,t)=>{if(typeof i3.__branch=="object"&&i3.__operator&&!i3.__branchApplied){let n=i3.__operator;i3.__branchApplied=true,i3.__operator=(...s)=>{let r=n(...s);for(let _2 in i3.__branch){let o=()=>{typeof i3.__branch[_2].then=="function"?i3.__branch[_2].then(r):i3.__branch[_2].then instanceof y&&i3.__branch[_2].then.__operator?i3.__branch[_2].then.__operator(r):r=i3.__branch[_2].then};typeof i3.__branch[_2].if=="function"?i3.__branch[_2].if(r)==true&&o():i3.__branch[_2].if===r&&o()}return r}}if(i3.__listeners){for(let n in i3.__listeners)if(typeof i3.__listeners[n]=="object"&&i3.__listeners[n].branch&&!i3.__listeners[n].branchApplied){let s=i3.__listeners[n].callback;i3.__listeners[n].branchApplied=true,i3.__listeners.callback=r=>{let _2=()=>{typeof i3.__listeners[n].branch.then=="function"?r=i3.__listeners[n].branch.then(r):i3.__listeners[n].branch.then instanceof y&&i3.__listeners[n].branch.then.__operator?r=i3.__listeners[n].branch.then.__operator(r):r=i3.__listeners[n].branch.then};return typeof i3.__listeners[n].branch.if=="function"?i3.__listeners[n].branch.if(r)&&_2():i3.__listeners[n].branch.if===r&&_2(),s(r)}}}};var W=(i3,e,t)=>{if(i3.__listeners)for(let n in i3.__listeners)typeof i3.__listeners[n]=="object"&&i3.__listeners[n].oncreate&&i3.__listeners[n].callback(i3.__listeners[n].oncreate)};var V=(i3,e,t)=>{if(i3.__listeners)for(let n in i3.__listeners)typeof i3.__listeners[n]=="object"&&typeof i3.__listeners[n].binding=="object"&&(i3.__listeners.callback=i3.__listeners.callback.bind(i3.__listeners[n].binding))};var B=(i3,e,t)=>{if(i3.__listeners){for(let n in i3.__listeners)if(typeof i3.__listeners[n]=="object"&&typeof i3.__listeners[n].transform=="function"&&!i3.__listeners[n].transformApplied){let s=i3.__listeners[n].callback;i3.__listeners[n].transformApplied=true,i3.__listeners.callback=r=>(r=i3.__listeners[n].transform(r),s(r))}}};var H=(i3,e,t)=>{i3.post&&!i3.__operator?i3.__setOperator(i3.post):!i3.__operator&&typeof i3.get=="function"&&i3.__setOperator(i3.get),!i3.get&&i3.__operator,i3.aliases&&i3.aliases.forEach(n=>{t.set(n,i3);let s=r=>{t.__node.nodes.delete(n)};i3.__addOndisconnected(s)}),typeof t.__node.roots?.[i3.__node.tag]=="object"&&i3.get&&(t.__node.roots[i3.__node.tag].get=i3.get)};var F={backprop:C,loop:T,animate:$,branching:J,triggerListenerOncreate:W,bindListener:V,transformListenerResult:B,substitute__operator:H};var U=i3=>{let e={};for(let t in i3)typeof i3[t]=="object"?e[t]=U(i3[t]):typeof i3[t]=="function"?e[t]=i3[t].toString():e[t]=i3[t];return e};function se(i3){typeof i3!="string"&&(i3=i3.toString());let e=i3.match(/\(?[^]*?\)?\s*=>/);if(e)return e[0].replace(/[()\s]/gi,"").replace("=>","").split(",");let t=i3.match(/\([^]*?\)/);return t?t[0].replace(/[()\s]/gi,"").split(","):[]}var D=i3=>{let e=i3.indexOf("=>")+1;return e<=0&&(e=i3.indexOf("){")),e<=0&&(e=i3.indexOf(") {")),i3.slice(0,i3.indexOf("{",e)+1)};function P(i3=""){let e=r=>r.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4"),t=D(i3),n=e(i3),s;if(t.includes("function")){let r=t.substring(t.indexOf("(")+1,t.lastIndexOf(")"));s=new Function(r,n)}else if(t.substring(0,6)===n.substring(0,6)){let r=t.substring(t.indexOf("(")+1,t.lastIndexOf(")"));s=new Function(r,n.substring(n.indexOf("{")+1,n.length-1))}else try{s=(0,eval)(i3)}catch{}return s}var k=function(){let i3=new Map,e=[],t=["this"];function n(){i3.clear(),e.length=0,t.length=1}function s(_2,o){var a=e.length-1,f2=e[a];if(typeof f2=="object")if(f2[_2]===o||a===0)t.push(_2),e.push(o.pushed);else for(;a-->=0;){if(f2=e[a],typeof f2=="object"&&f2[_2]===o){a+=2,e.length=a,t.length=a,--a,e[a]=o,t[a]=_2;break}a--}}function r(_2,o){if(o!=null&&typeof o=="object"){_2&&s(_2,o);let a=i3.get(o);if(a)return"[Circular Reference]"+a;i3.set(o,t.join("."))}return o}return function(o,a){try{return e.push(o),JSON.stringify(o,r,a)}finally{n()}}}();JSON.stringifyWithCircularRefs===void 0&&(JSON.stringifyWithCircularRefs=k);var z=function(){let i3=new Map,e=[],t=["this"];function n(){i3.clear(),e.length=0,t.length=1}function s(_2,o){var a=e.length-1,f2=e[a];if(typeof f2=="object")if(f2[_2]===o||a===0)t.push(_2),e.push(o.pushed);else for(;a-->=0;){if(f2=e[a],typeof f2=="object"&&f2[_2]===o){a+=2,e.length=a,t.length=a,--a,e[a]=o,t[a]=_2;break}a--}}function r(_2,o){if(o!=null&&typeof o=="object"){_2&&s(_2,o);let a=i3.get(o);if(a)return"[Circular Reference]"+a;i3.set(typeof o=="function"?o.toString():o,t.join("."))}return typeof o=="function"?o.toString():o}return function(o,a){try{return e.push(o),JSON.stringify(o,r,a)}finally{n()}}}();JSON.stringifyWithFunctionsAndCircularRefs===void 0&&(JSON.stringifyWithFunctionsAndCircularRefs=z);var Q=function(){let i3=new Map,e=[],t=["this"];function n(){i3.clear(),e.length=0,t.length=1}function s(_2,o){var a=e.length-1;if(e[a]){var f2=e[a];if(typeof f2=="object")if(f2[_2]===o||a===0)t.push(_2),e.push(o.pushed);else for(;a-->=0;){if(f2=e[a],typeof f2=="object"&&f2[_2]===o){a+=2,e.length=a,t.length=a,--a,e[a]=o,t[a]=_2;break}a++}}}function r(_2,o){let a;if(o!=null)if(typeof o=="object"){let f2=o.constructor.name;_2&&f2==="Object"&&s(_2,o);let l=i3.get(o);if(l)return"[Circular Reference]"+l;if(i3.set(o,t.join(".")),f2==="Array")o.length>20?a=o.slice(o.length-20):a=o;else if(f2.includes("Set"))a=Array.from(o);else if(f2!=="Object"&&f2!=="Number"&&f2!=="String"&&f2!=="Boolean")a="instanceof_"+f2;else if(f2==="Object"){let c2={};for(let d2 in o)if(o[d2]==null)c2[d2]=o[d2];else if(Array.isArray(o[d2]))o[d2].length>20?c2[d2]=o[d2].slice(o[d2].length-20):c2[d2]=o[d2];else if(o[d2].constructor.name==="Object"){c2[d2]={};for(let u in o[d2])if(Array.isArray(o[d2][u]))o[d2][u].length>20?c2[d2][u]=o[d2][u].slice(o[d2][u].length-20):c2[d2][u]=o[d2][u];else if(o[d2][u]!=null){let h2=o[d2][u].constructor.name;h2.includes("Set")?c2[d2][u]=Array.from(o[d2][u]):h2!=="Number"&&h2!=="String"&&h2!=="Boolean"?c2[d2][u]="instanceof_"+h2:c2[d2][u]=o[d2][u]}else c2[d2][u]=o[d2][u]}else{let u=o[d2].constructor.name;u.includes("Set")?c2[d2]=Array.from(o[d2]):u!=="Number"&&u!=="String"&&u!=="Boolean"?c2[d2]="instanceof_"+u:c2[d2]=o[d2]}a=c2}else a=o}else a=o;return a}return function(o,a){e.push(o);let f2=JSON.stringify(o,r,a);return n(),f2}}();JSON.stringifyFast===void 0&&(JSON.stringifyFast=Q);function ae(i3){if(typeof i3.__methods=="object")for(let e in i3.__methods){let t=i3.__methods[e],n=typeof t=="function"?t:P(t);e==="__operator"?i3.__setOperator(n):i3[e]=n.bind(i3)}}var L=class extends b{name=`service${Math.floor(Math.random()*1e15)}`;restrict;constructor(e){super({...e,loaders:e?.loaders?Object.assign({...F},e.loaders):{...F}}),e?.services&&this.addServices(e.services),e?.restrict&&(this.restrict=e.restrict),this.load(this)}addServices=e=>{for(let t in e)if(typeof e[t]=="function"&&(e[t]=new e[t]),e[t]?.__node?.loaders&&Object.assign(this.__node.loaders,e[t].__node.loaders),e[t]?.__node?.nodes){e[t].__node.nodes.forEach((r,_2)=>{this.get(_2)?this.set(t+"."+_2,r):this.set(_2,r)}),this.__node.nodes.forEach((r,_2)=>{e[t].__node.nodes.get(_2)||e[t].__node.nodes.set(_2,r)});let n=this.set;this.set=(r,_2)=>(e[t].set(r,_2),n(r,_2));let s=this.delete;this.delete=r=>(e[t].delete(r),s(r))}else typeof e[t]=="object"&&this.load(e[t])};handleMethod=(e,t,n)=>{let s=t,r=this.__node.nodes.get(e);if(r||(r=this.__node.roots[e]),r?.[s])if(typeof r[s]!="function"){if(n){Array.isArray(n)&&n.length===1?r[s]=n[0]:r[s]=n;return}return r[s]}else return Array.isArray(n)?r[s](...n):r[s](n);else return this.handleServiceMessage({route:e,args:n,method:t})};handleServiceMessage(e){let t;return typeof e=="object"&&(e.route?t=e.route:e.node&&(t=e.node)),t?Array.isArray(e.args)?this.run(t,...e.args):this.run(t,e.args):e}handleGraphNodeCall(e,t){if(!e)return t;if(t?.args)this.handleServiceMessage(t);else return Array.isArray(t)?this.run(e,...t):this.run(e,t)}transmit=(...e)=>{if(typeof e[0]=="object"){let t=e[0];if(t.method)return this.handleMethod(t.route,t.method,t.args);if(t.route)return this.handleServiceMessage(t);if(t.node)return this.handleGraphNodeCall(t.node,t.args);this.__node.keepState&&(t.route&&this.setState({[t.route]:t.args}),t.node&&this.setState({[t.node]:t.args}));return}else return};receive=(...e)=>{if(e[0]){let t=e[0];if(typeof t=="string"){let n=t.substring(0,8);(n.includes("{")||n.includes("["))&&(n.includes("\\")&&(t=t.replace(/\\/g,"")),t[0]==='"'&&(t=t.substring(1,t.length-1)),t=JSON.parse(t))}if(typeof t=="object"){if(t.method)return this.restrict?.[t.route]?void 0:this.handleMethod(t.route,t.method,t.args);if(t.route)return this.restrict?.[t.route]?void 0:this.handleServiceMessage(t);if(t.node)return typeof t.node=="string"&&this.restrict?.[t.node]?void 0:this.handleGraphNodeCall(t.node,t.args);this.__node.keepState&&(t.route&&this.setState({[t.route]:t.args}),t.node&&this.setState({[t.node]:t.args}));return}}};pipe=(e,t,n,s,r)=>{if(e instanceof y)return r?this.subscribe(e,_2=>{let o=r(_2);o!==void 0?this.transmit({route:t,args:o,method:s}):this.transmit({route:t,args:_2,method:s},n)}):this.subscribe(e,_2=>{this.transmit({route:t,args:_2,method:s},n)});if(typeof e=="string")return this.subscribe(e,_2=>{this.transmit({route:t,args:_2,method:s},n)})};pipeOnce=(e,t,n,s,r)=>{if(e instanceof y)return r?e.__node.state.subscribeEventOnce(e.__node.unique,_2=>{let o=r(_2);o!==void 0?this.transmit({route:t,args:o,method:s}):this.transmit({route:t,args:_2,method:s},n)}):this.__node.state.subscribeEventOnce(e.__node.unique,_2=>{this.transmit({route:t,args:_2,method:s},n)});if(typeof e=="string")return this.__node.state.subscribeEventOnce(this.__node.nodes.get(e).__node.unique,_2=>{this.transmit({route:t,args:_2,method:s},n)})};terminate=(...e)=>{};isTypedArray=X;recursivelyAssign=M;spliceTypedArray=Y;ping=()=>(console.log("pinged!"),"pong");echo=(...e)=>(this.transmit(...e),e);log=(...e)=>(console.log(...e),true);error=(...e)=>(console.error(...e),true)};function X(i3){return ArrayBuffer.isView(i3)&&Object.prototype.toString.call(i3)!=="[object DataView]"}var M=(i3,e)=>{for(let t in e)e[t]?.constructor.name==="Object"&&!Array.isArray(e[t])?i3[t]?.constructor.name==="Object"&&!Array.isArray(i3[t])?M(i3[t],e[t]):i3[t]=M({},e[t]):i3[t]=e[t];return i3};function Y(i3,e,t){let n=i3.subarray(0,e),s;t&&(s=i3.subarray(t+1));let r;return(n.length>0||s?.length>0)&&(r=new i3.constructor(n.length+s.length)),r&&(n.length>0&&r.set(n),s&&s.length>0&&r.set(s,n.length)),r}var nodeTemplates={};var remoteGraphRoutes={transferNode:(properties,connection,name2)=>{let str;if(typeof properties==="object"){if(!properties.__node){properties.__node={}}if(name2)properties.__node.tag=name2;for(const key in properties){if(typeof properties[key]==="function"){if(!properties.__methods)properties.__methods={};properties.__methods[key]=properties[key].toString()}}str=U(properties)}else if(typeof properties==="function")str=properties.toString();else if(typeof properties==="string")str=properties;if(str){if(connection.run)return connection.run("setNode",[str]);else if(connection.postMessage){connection.postMessage({route:"setNode",args:str},void 0);return new Promise(r=>r(name2))}else if(connection.send){connection.send(JSON.stringify({route:"setNode",args:str}));return new Promise(r=>r(name2))}}},setNode:function(properties,name2){if(typeof properties==="object"){if(properties.__methods){if(!this.__node.graph.__node.loaders.methodstrings){this.__node.graph.__node.loaders.methodstrings=ae}}}if(typeof properties==="string"){let f2=P(properties);if(typeof f2==="function")properties={__operator:f2,__node:{tag:name2?name2:f2.name}};else{f2=JSON.parse(properties);if(typeof f2==="object")properties=f2}}if(typeof properties==="object"||typeof properties==="function"){let template={};if(typeof properties==="object")Object.assign(template,properties);else template.__operator=properties;let node=this.__node.graph.add(template);if(node){nodeTemplates[node.__node.tag]=template;return node.__node?.tag}else return false}else return false},makeNodeTransferrable:function(properties,name2){if(!properties.__node){properties.__node={}}if(name2)properties.__node.tag=name2;for(const key in properties){if(typeof properties[key]==="function"){if(!properties.__methods)properties.__methods={};properties.__methods[key]=properties[key].toString()}}const str=U(properties);return str},getListenerJSON:function(){const triggers=this.__node.state.triggers;let result={};for(const key in triggers){triggers[key].forEach(trigger=>{let t=trigger;if(!result[t.target])result[t.target]={};let l=t.source+(t.key?"."+t.key:"");result[t.target][l]={__callback:t.__callback};if(t.__args)result[t.target][l].__args=t.__args;if(t.subInput)result[t.target][l].subInput=t.subInput})}return result},makeRootTransferrable:function(){let roots={};for(const r in this.__node.graph.__node.roots){let properties=this.__node.graph.__node.roots[r];if(typeof properties==="function"){roots[r]=properties.toString()}else if(typeof properties!=="object"){roots[r]=properties}else{roots[r]={};let keys=Object.getOwnPropertyNames(properties).filter(v2=>!objProps.includes(v2));let nonArrowFunctions=Object.getOwnPropertyNames(Object.getPrototypeOf(properties)).filter(v2=>!objProps.includes(v2));keys.push(...nonArrowFunctions);for(const key of keys){if(typeof properties[key]==="function"){roots[r][key]=properties[key].toString()}else if(typeof properties[key]==="object")roots[r][key]=z(properties[key]);else roots[r][key]=properties[key]}}}return roots},setTemplate:function(properties,name2){if(typeof properties==="object"){if(properties.__methods){if(!this.__node.graph.__node.loaders.methodstrings){this.__node.graph.__node.loaders.methodstrings=ae}}}if(typeof properties==="string"){let f2=P(properties);if(typeof f2==="function"){if(!name2)name2=f2.name;properties={__operator:f2,__node:{tag:name2}}}else{f2=JSON.parse(properties);if(typeof f2==="object"){properties=f2;if(!name2&&f2.__node?.tag)name2=f2.__node.tag}}}if(!name2)name2=`node${Math.floor(Math.random()*1e15)}`;if(typeof properties==="object"||typeof properties==="function"){nodeTemplates[name2]=properties;return name2}else return false},loadFromTemplate:function(templateName,name2,properties){if(nodeTemplates[templateName]){let cpy=M({},nodeTemplates[templateName]);if(name2){if(!cpy.__node)cpy.__node={};cpy.__node.tag=name2}if(properties)Object.assign(cpy,properties);let node=this.__node.graph.add(cpy);return node.__node.tag}},setMethod:function(nodeTag,fn,methodKey){if(typeof fn==="string"){let f2=P(fn);if(typeof f2==="function")fn=f2}if(!methodKey&&typeof fn==="function")methodKey=fn.name;if(this.__node.graph.get(nodeTag)){this.__node.graph.get(nodeTag)[methodKey]=fn}else this.__node.graph.add({__node:{tag:methodKey,[methodKey]:fn}});return true},assignNode:function(nodeTag,source){if(this.__node.graph.get(nodeTag)&&typeof source==="object"){Object.assign(this.__node.graph.get(nodeTag),source)}},getNodeProperties:function(nodeTag){let node=this.__node.graph.get(nodeTag);if(node){let properties=Object.getOwnPropertyNames(node);let result={};for(const key of properties){if(typeof node[key]==="function"){let str=node[key].toString();let isNative=str.indexOf("[native code]")>-1;result[key]={type:"function",args:se(node[key]),native:isNative}}else result[key]=typeof node[key]}return result}return void 0},proxyRemoteNode:function(name2,connection){return new Promise((res,rej)=>{connection.run("getNodeProperties",name2).then(props=>{let proxy={};if(typeof props==="object"){for(const key in props){if(props[key]?.type==="function"){if(props[key].native||props[key].args){proxy[key]=(...args)=>{return new Promise(r=>{connection.run(name2,args,key).then(r)})}}else{proxy[key]=()=>{return new Promise(r=>{connection.run(name2,void 0,key).then(r)})}}}else{Object.defineProperty(proxy,key,{get:()=>{return new Promise(r=>{connection.run(name2,void 0,key).then(r)})},set:value=>{connection.post(name2,value,key)},configurable:true,enumerable:true})}}}res(proxy)})})},transferClass:(classObj,connection,className)=>{if(typeof classObj==="object"){let str=classObj.toString();let message={route:"receiveClass",args:[str,className]};if(connection.run)return connection.run("receiveClass",[str,className]);else if(connection.postMessage){connection.postMessage({route:"receiveClass",args:[str,className]},void 0);return new Promise(r=>r(name))}else if(connection.send){connection.send(JSON.stringify({route:"receiveClass",args:[str,className]}));return new Promise(r=>r(name))}return message}return false},receiveClass:function(stringified,className){if(typeof stringified==="string"){if(stringified.indexOf("class")===0){let cls=(0,eval)("("+stringified+")");let name2=className;if(!name2)name2=cls.name;this.__node.graph[name2]=cls;return true}}return false},transferFunction:(fn,connection,fnName)=>{if(!fnName)fnName=fn.name;let str=fn.toString();let message={route:"setNode",args:[str,fnName]};if(connection.run)return connection.run("setNode",[str,fnName]);else if(connection.postMessage){connection.postMessage({route:"setNode",args:[str,fnName]},void 0);return new Promise(r=>r(fnName))}else if(connection.send){connection.send(JSON.stringify({route:"setNode",args:[str,fnName]}));return new Promise(r=>r(fnName))}return message},setGlobal:(key,value)=>{globalThis[key]=value;return true},assignGlobalObject:(target,source)=>{if(!globalThis[target])return false;if(typeof source==="object")Object.assign(globalThis[target],source);return true},setValue:function(key,value){this.__node.graph[key]=value;return true},assignObject:function(target,source){if(!this.__node.graph[target])return false;if(typeof source==="object")Object.assign(this.__node.graph[target],source);return true},setGlobalFunction:(fn,fnName)=>{if(typeof fn==="string")fn=P(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;globalThis[fnName]=fn;return true}return false},setGraphFunction:function(fn,fnName){if(typeof fn==="string")fn=P(fn);if(typeof fn==="function"){if(!fnName)fnName=fn.name;this.__node.graph[fnName]=fn;return true}return false}};var objProps=Object.getOwnPropertyNames(Object.getPrototypeOf({}));var browser_default=Worker;var WorkerService=class extends L{name="worker";workers={};threadRot=0;connections;constructor(options){super();this.connections={workers:this.workers};if(options?.services)this.addServices(options.services);this.load(this);this.setLoaders(this.workerloader);if(options)this.init(options);if(typeof WorkerGlobalScope!=="undefined"&&globalThis instanceof WorkerGlobalScope){this.addDefaultMessageListener()}}loadWorkerRoute=(node,routeKey)=>{if(node.workerUrl)node.url=node.workerUrl;if(node._id)node.__node.tag=node._id;if(!node.__node.tag)node.__node.tag=routeKey;node._id=node.__node.tag;let worker;if(this.workers[node._id])worker=this.workers[node._id];else if(node.worker)worker=node.worker;if(!worker){worker=this.addWorker(node)}node.worker=worker;if(!node.__ondisconnected){let ondelete=rt=>{rt.worker?.terminate()};node.__addOndisconnected(ondelete)}if(node.transferFunctions){for(const prop in node.transferFunctions){this.transferFunction(worker,node.transferFunctions[prop],prop)}}if(node.transferClasses){for(const prop in node.transferClasses){this.transferClass(worker,node.transferClasses[prop],prop)}}if(worker){if(!node.__operator){node.__operator=(...args)=>{if(node.callback){if(!this.__node.nodes.get(node.__node.tag)?.__children)worker.post(node.callback,args);else return worker.run(node.callback,args)}else{if(!this.__node.nodes.get(node.__node.tag)?.__children)worker.send(args);else return worker.request(args)}}}if(node.init){worker.run(node.init,node.initArgs,void 0,node.initTransfer)}return worker}};workerloader={"workers":(node,parent,graph,roots)=>{let rt=node;if(!node.parentRoute&&(parent?.callback&&parent?.worker))node.parentRoute=parent?.callback;if(rt?.worker||rt?._id&&this.workers[rt._id]||rt?.workerUrl){let worker=this.loadWorkerRoute(rt,rt.__node.tag);if(worker){if(!rt.parentRoute&&rt.__parent?.callback)rt.parentRoute=rt.__parent.callback;if(rt.__parent&&!rt.portId){if(typeof rt.__parent==="string"){if(rt.__node.tag!==rt.__parent&&worker._id!==rt.__parent)rt.portId=this.establishMessageChannel(worker,rt.__parent)}else if(rt.__node.tag!==rt.__parent?.__node?.tag&&worker._id!==rt.__parent?.tag){rt.portId=this.establishMessageChannel(worker,rt.__parent.worker)}};if(rt.parentRoute){if(!rt.stopped){if(typeof rt.__parent==="string"&&rt.__parent===worker._id){worker.run("subscribe",[rt.parentRoute,void 0,void 0,rt.callback])}else if(rt.__node.tag===rt.__parent?.__node?.tag||worker._id===rt.__parent?.__node?.tag){worker.run("subscribe",[rt.parentRoute,void 0,void 0,rt.callback])}else worker.run("subscribeToWorker",[rt.parentRoute,rt.portId,void 0,rt.callback,void 0,void 0,rt.blocking]).then(sub=>{worker.workerSubs[rt.parentRoute+rt.portId].sub=sub})}if(!(typeof rt.__parent==="string"&&rt.__parent===worker._id)&&!(rt.__node.tag===rt.__parent?.__node?.tag||worker._id===rt.__parent?.__node?.tag))worker.workerSubs[rt.parentRoute+rt.portId]={sub:null,route:rt.parentRoute,portId:rt.portId,callback:rt.callback,blocking:rt.blocking}}else if(rt.__parent){if(typeof rt.__parent==="string"){if(!rt.stopped){if(rt.__parent===worker._id){worker.run("subscribe",[rt.__parent,void 0,rt.callback])}else worker.run("subscribeToWorker",[rt.__parent,rt.portId,void 0,rt.callback,void 0,void 0,rt.blocking]).then(sub=>{worker.workerSubs[rt.__parent+rt.portId].sub=sub})}if(!(typeof rt.__parent==="string"&&rt.__parent===worker._id))worker.workerSubs[rt.__parent+rt.portId]={sub:null,route:worker._id,portId:rt.portId,callback:rt.callback,blocking:rt.blocking}}else if(rt.__parent?.__node?.tag&&rt.__parent?.worker){if(!rt.stopped){if(rt.__node.tag===rt.__parent.__node.tag||worker._id===rt.__parent.__node.tag){worker.run("subscribe",[rt.__parent.__node.tag,void 0,void 0,rt.callback])}else worker.run("subscribeToWorker",[rt.__parent.__node.tag,rt.portId,void 0,rt.callback,void 0,void 0,rt.blocking]).then(sub=>{worker.workerSubs[rt.__parent.__node.tag+rt.portId].sub=sub})}if(!(rt.__node.tag===rt.__parent?.__node?.tag||worker._id===rt.__parent?.__node?.tag))worker.workerSubs[rt.__parent.__node.tag+rt.portId]={sub:null,route:rt.__parent.__node.tag,portId:rt.portId,callback:rt.callback,blocking:rt.blocking}}}}}else if(rt.__parent&&rt.parentRoute){if(typeof rt.__parent==="string"&&roots[rt.__parent]?.worker){roots[rt.__parent].worker.subscribe(rt.parentRoute,rt.__operator,void 0,void 0,void 0,rt.blocking)}else if(rt.__parent?.worker){rt.__parent.worker.subscribe(rt.parentRoute,rt.__operator,void 0,void 0,void 0,rt.blocking)}}return rt}};addDefaultMessageListener=()=>{globalThis.onmessage=ev=>{let result=this.receive(ev.data);if(this.__node.keepState)this.setState({[this.name]:result})}};postMessage=(message,target,transfer)=>{if(this.workers[target]){this.workers[target].send(message,transfer)}else{globalThis.postMessage(message,target,transfer)}};addWorker=options=>{let worker;if(!options._id)options._id=`worker${Math.floor(Math.random()*1e15)}`;if(options.url)worker=new browser_default(options.url);else if(options.port){worker=options.port}else if(this.workers[options._id]){if(this.workers[options._id].port)worker=this.workers[options._id].port;else worker=this.workers[options._id].worker}if(!worker)return;let send=(message,transfer)=>{return this.transmit(message,worker,transfer)};let post=(route,args,method,transfer)=>{let message={route,args};if(method)message.method=method;return this.transmit(message,worker,transfer)};let run=(route,args,method,transfer)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[{route,args},options._id,callbackId]};if(method)req.args[0].method=method;let onmessage=ev=>{if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};let request=(message,method,transfer)=>{return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,options._id,callbackId]};if(method)req.method=method;let onmessage=ev=>{if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};let workerSubs={};let subscribe=(route,callback,args,key,subInput,blocking)=>{return this.subscribeToWorker(route,options._id,callback,args,key,subInput,blocking)};let unsubscribe=(route,sub)=>{return run("unsubscribe",[route,sub])};let start=async(route,portId,callback,blocking)=>{if(route)await run("subscribeToWorker",[route,portId,void 0,callback,blocking]).then(sub=>{if(sub)workerSubs[route+portId]={sub,route,portId,callback,blocking}});else for(const key in workerSubs){if(typeof workerSubs[key].sub!=="number")await run("subscribeToWorker",[workerSubs[key].route,workerSubs[key].portId,void 0,workerSubs[key].callback,void 0,workerSubs[key].blocking]).then(sub=>{workerSubs[key].sub=sub});console.log(JSON.stringify(workerSubs))}return true};let stop=async(route,portId)=>{if(route&&portId&&workerSubs[route+portId]){await run("unsubscribe",[route,workerSubs[route+portId].sub]);workerSubs[route+portId].sub=false}else{for(const key in workerSubs){if(typeof workerSubs[key].sub==="number"){await run("unpipeWorkers",[workerSubs[key].route,workerSubs[key].portId,workerSubs[key].sub]).then(console.log)}workerSubs[key].sub=false}}return true};let terminate=()=>{for(const key in workerSubs){if(typeof workerSubs[key].sub==="number"){run("unpipeWorkers",[workerSubs[key].route,workerSubs[key].portId,workerSubs[key].sub])}workerSubs[key].sub=false}return this.terminate(options._id)};if(!options.onmessage)options.onmessage=ev=>{this.receive(ev.data);this.setState({[options._id]:ev.data})};if(!options.onerror){options.onerror=ev=>{console.error(ev.data)}}worker.onmessage=options.onmessage;worker.onerror=options.onerror;let workersettings={worker,__node:{tag:options._id},send,post,run,request,subscribe,unsubscribe,terminate,start,stop,postMessage:worker.postMessage,workerSubs,graph:this,...options};let node=this.add(workersettings);this.workers[options._id]=node;node.__addOndisconnected(function(){terminate()});return this.workers[options._id]};open=this.addWorker;close=()=>{globalThis.close()};getTransferable(message){let transfer;if(typeof message==="object"){if(message.args){if(message.args?.constructor?.name==="Object"){for(const key in message.args){if(ArrayBuffer.isView(message.args[key])){if(!transfer)transfer=[message.args[key].buffer];else transfer.push(message.args[key].buffer)}else if(message.args[key]?.constructor?.name==="ArrayBuffer"){if(!transfer)transfer=[message.args[key]];else transfer.push(message.args[key])}}}else if(Array.isArray(message.args)&&message.args.length<11){message.args.forEach(arg=>{if(ArrayBuffer.isView(arg)){transfer=[arg.buffer]}else if(arg?.constructor?.name==="ArrayBuffer")transfer=[arg]})}else if(ArrayBuffer.isView(message.args)){transfer=[message.args.buffer]}else if(message.args?.constructor?.name==="ArrayBuffer"){transfer=[message]}}else if(message?.constructor?.name==="Object"){for(const key in message){if(ArrayBuffer.isView(message[key])){if(!transfer)transfer=[message[key].buffer];else transfer.push(message[key].buffer)}else if(message[key]?.constructor?.name==="ArrayBuffer"){if(!transfer)transfer=[message[key]];else transfer.push(message[key])}}}else if(Array.isArray(message)&&message.length<11){message.forEach(arg=>{if(ArrayBuffer.isView(arg)){transfer=[arg.buffer]}else if(arg.constructor?.name==="ArrayBuffer")transfer=[arg]})}else if(ArrayBuffer.isView(message)){transfer=[message.buffer]}else if(message.constructor?.name==="ArrayBuffer"){transfer=[message]}}return transfer}transmit=(message,worker,transfer)=>{if(!transfer){transfer=this.getTransferable(message)}if(worker instanceof browser_default||worker instanceof MessagePort){worker.postMessage(message,transfer)}else if(typeof worker==="string"){if(this.workers[worker]){if(this.workers[worker].port)this.workers[worker].port.postMessage(message,transfer);else if(this.workers[worker].worker)this.workers[worker].worker.postMessage(message,transfer)}}else{let keys=Object.keys(this.workers);this.workers[keys[this.threadRot]].worker.postMessage(message,transfer);this.threadRot++;if(this.threadRot===keys.length)this.threadRot=0}return message};terminate=worker=>{let onclose;let str;if(typeof worker==="string"){str=worker;let obj=this.workers[worker];if(obj){delete this.workers[worker];worker=obj.worker;if(obj.onclose)onclose=obj.onclose}}else if(typeof worker==="object"){if(worker?._id){worker=worker.worker;delete this.workers[worker?._id]}}if(worker instanceof browser_default){worker.terminate();if(onclose)onclose(worker);if(str&&this.get(str))this.remove(str);return true}if(worker instanceof MessagePort){worker.close();if(onclose)onclose(worker);if(str&&this.get(str))this.remove(str);return true}return false};establishMessageChannel=(worker,worker2)=>{let workerId;if(typeof worker==="string"){workerId=worker;if(this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker2=this.workers[worker].worker}}else if(worker?.worker){worker=worker.worker}if(typeof worker2==="string"){if(this.workers[worker2]){if(this.workers[worker2].port)worker2=this.workers[worker2].port;else worker2=this.workers[worker2].worker}}else if(worker2?.worker){worker2=worker2.worker}if(worker instanceof browser_default||worker instanceof MessagePort){let channel=new MessageChannel;let portId=`port${Math.floor(Math.random()*1e15)}`;worker.postMessage({route:"addWorker",args:{port:channel.port1,_id:portId}},[channel.port1]);if(worker2 instanceof browser_default||worker2 instanceof MessagePort){worker2.postMessage({route:"addWorker",args:{port:channel.port2,_id:portId}},[channel.port2])}else if(workerId&&this.workers[workerId]){channel.port2.onmessage=this.workers[workerId].onmessage;this.workers[workerId].port=channel.port2}return portId}return false};request=(message,workerId,transfer,method)=>{let worker=this.workers[workerId].worker;return new Promise((res,rej)=>{let callbackId=Math.random();let req={route:"runRequest",args:[message,callbackId]};if(method)req.method=method;let onmessage=ev=>{if(typeof ev.data==="object"){if(ev.data.callbackId===callbackId){worker.removeEventListener("message",onmessage);res(ev.data.args)}}};worker.addEventListener("message",onmessage);this.transmit(req,worker,transfer)})};runRequest=(message,worker,callbackId,getTransferable=true)=>{let res=this.receive(message);if(typeof worker==="string"&&this.workers[worker]){if(this.workers[worker].port)worker=this.workers[worker].port;else worker=this.workers[worker].worker}if(res instanceof Promise){res.then(r=>{let transfer=getTransferable?this.getTransferable(r):void 0;if(worker instanceof browser_default||worker instanceof MessagePort)worker.postMessage({args:r,callbackId},transfer);else if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope)globalThis.postMessage({args:r,callbackId},transfer)})}else{let transfer=getTransferable?this.getTransferable(res):void 0;if(worker instanceof browser_default||worker instanceof MessagePort)worker.postMessage({args:res,callbackId},transfer);else if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope)globalThis.postMessage({args:res,callbackId},transfer)}return res};subscribeWorker=(route,worker,args,key,subInput,blocking,getTransferable=true)=>{if(this.restrict?.[route])return void 0;let callback;if(blocking){let blocked=false;callback=res=>{if(!blocked){blocked=true;if(res instanceof Promise){res.then(r=>{if(worker?.run)worker.run("triggerSubscription",[route,worker._id,r]).then(ret=>{blocked=false})})}else{if(worker?.run)worker.run("triggerSubscription",[route,worker._id,res]).then(ret=>{blocked=false})}}}}else{callback=res=>{if(res instanceof Promise){res.then(r=>{let transfer=getTransferable?this.getTransferable(r):void 0;if(worker?.postMessage)worker.postMessage({args:r,callbackId:route},transfer);else if(globalThis.postMessage)globalThis.postMessage({args:r,callbackId:route},transfer)})}else{let transfer=getTransferable?this.getTransferable(res):void 0;if(worker?.postMessage)worker.postMessage({args:res,callbackId:route},transfer);else if(globalThis.postMessage)globalThis.postMessage({args:res,callbackId:route},transfer)}}}if(!blocking&&worker?.port){worker=worker.port}else if(!blocking&&worker?.worker){worker=worker.worker}else if(typeof worker==="string"&&this.workers[worker]){if(blocking)worker=this.workers[worker];else if(this.workers[worker].port)worker=this.workers[worker].port;else worker=this.workers[worker].worker}return this.subscribe(route,callback,args,key,subInput)};subscribeToWorker=(route,workerId,callback,args,key,subInput,blocking,getTransferable=true)=>{if(typeof workerId==="string"&&this.workers[workerId]){this.__node.state.subscribeEvent(workerId,res=>{if(res?.callbackId===route){if(!callback)this.setState({[workerId]:res.args});else if(typeof callback==="string"){this.run(callback,res.args)}else callback(res.args)}});return this.workers[workerId].run("subscribeWorker",[route,workerId,args,key,subInput,blocking,getTransferable])}};triggerSubscription=async(route,workerId,result)=>{if(this.__node.state.triggers[workerId])for(let i3=0;i3<this.__node.state.triggers[workerId].length;i3++){await this.__node.state.triggers[workerId][i3].onchange({args:result,callbackId:route})}return true};pipeWorkers=(sourceWorker,listenerWorker,sourceRoute,listenerRoute,portId,args,key,subInput,blocking,getTransferable)=>{if(typeof sourceWorker==="string")sourceWorker=this.workers[sourceWorker];if(typeof listenerWorker==="string")listenerWorker=this.workers[listenerWorker];if(!portId){portId=this.establishMessageChannel(sourceWorker.worker,listenerWorker.worker)}return listenerWorker.run("subscribeToWorker",[sourceRoute,portId,listenerRoute,args,key,subInput,blocking,getTransferable])};unpipeWorkers=(sourceRoute,sourceWorker,sub)=>{if(typeof sourceWorker==="string")sourceWorker=this.workers[sourceWorker];if(typeof sourceWorker==="object"){return sourceWorker.run("unsubscribe",[sourceRoute,sub])}}};var import_meta={};var F2=(t=>typeof __require<"u"?__require:typeof Proxy<"u"?new Proxy(t,{get:(e,n)=>(typeof __require<"u"?__require:e)[n]}):t)(function(t){if(typeof __require<"u")return __require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});var d=y2(["ctrlKey","metaKey","altKey","shiftKey","button","which","pointerType","clientX","clientY","pageX","pageY","movementX","movementY","x","y","which","timeStamp"]);var j2=y2(["deltaX","deltaY"]);var G2=y2(["ctrlKey","metaKey","shiftKey","altKey","isComposing","keyCode","key","code","repeat","timeStamp"]);var B2=y2(["alpha","beta","gamma","absolute","webkitCompassHeading","webkitCompassAccuracy"]);var K=(t,e,n)=>{n&&t.preventDefault&&t.preventDefault();let a={type:"devicemotion",acceleration:{x:t.acceleration.x,y:t.acceleration.y,z:t.acceleration.y},accelerationIncludingGravity:{x:t.accelerationIncludingGravity.x,y:t.accelerationIncludingGravity.y,z:t.accelerationIncludingGravity.y},rotationRate:{alpha:t.rotationRate.alpha,beta:t.rotationRate.beta,gamma:t.rotationRate.gamma},interval:t.interval};e(a)};var z2=(t,e,n)=>{n&&t.preventDefault&&t.preventDefault();let a={type:"orientation",target:{type:t.target.type,angle:t.target.angle}};e(a)};function X2(t,e,n){for(let a of e)n[a]=t[a]}function y2(t){return function(n,a,r){r&&n.preventDefault&&n.preventDefault();let s={type:n.type};X2(n,t,s),a(s)}}function Y2(t,e,n){n&&t.preventDefault&&t.preventDefault()}function P2(t,e){let n={type:t.type};n.isTrusted=t.isTrusted,n.bubbles=t.bubbles,n.cancelBubble=t.cancelBubble,n.cancelable=t.cancelable,n.composed=t.composed,n.defaultPrevent=t.defaultPrevented,n.eventPhase=t.eventPhase,n.returnValue=t.returnValue,n.currentTarget=t.currentTarget.id?t.currentTarget.id:t.currentTarget.constructor.name,n.target=n.currentTarget,n.srcElement=n.currentTarget,e(n)}function $2(t,e,n){n&&t.preventDefault&&t.preventDefault(),j2(t,e)}function m(t,e,n){n&&t.preventDefault&&t.preventDefault();let a=[],r={type:t.type,touches:a};for(let s=0;s<t.touches.length;++s){let i3=t.touches[s];a.push({pageX:i3.pageX,pageY:i3.pageY})}e(r)}var C2=1;var W2={};for(;C2<222;)W2[C2]=true,C2++;function A2(t,e,n){let{keyCode:a}=t;W2[a]&&(n&&t.preventDefault&&(a<110||a>123)&&t.preventDefault(),G2(t,e))}var c={contextmenu:Y2,mousedown:d,mousemove:d,mouseup:d,pointerdown:d,pointermove:d,pointerup:d,pointerlockchange:d,webkitpointerlockchange:d,focus:P2,blur:P2,pointerout:d,touchstart:m,touchmove:m,touchend:m,wheel:$2,keydown:A2,keyup:A2,deviceorientation:B2,devicemotion:K,orientation:z2};function p(t,e,n,a){n||(n="proxy"+Math.floor(Math.random()*1e15));let r=o=>{e?e.postMessage({route:"handleProxyEvent",args:[o,n]}):M2(o,n)},s=Object.entries(c),i3={};for(let[o,u]of s)i3[o]=function(O2){u(O2,r,a)},t.addEventListener(o,i3[o]);c.keydown&&(i3.keydown=function(o){c.keydown(o,r,a)},globalThis.addEventListener("keydown",i3.keydown)),c.keyup&&(i3.keyup=function(o){c.keyup(o,r,a)},globalThis.addEventListener("keyup",i3.keyup)),c.devicemotion&&(i3.devicemotion=function(o){c.devicemotion(o,r,a)},globalThis.addEventListener("devicemotion",i3.devicemotion)),c.deviceorientation&&(i3.deviceorientation=function(o){c.deviceorientation(o,r,a)},globalThis.addEventListener("deviceorientation",i3.deviceorientation)),c.orientation&&(i3.orientation=o=>{c.orientation(o,r,a)},screen.orientation.addEventListener("change",i3.orientation));let l=()=>{let o=t.getBoundingClientRect();r({type:"resize",left:o.left,top:o.top,width:t.clientWidth,height:t.clientHeight})};return l(),globalThis.addEventListener("resize",l),{functions:i3,terminate:()=>{for(let o in i3)o==="keyup"||o==="keydown"||o==="devicemotion"||o==="deviceorientation"?globalThis.removeEventListener(o,i3[o]):o==="orientation"?screen.orientation.removeEventListener("change",i3[o]):t.removeEventListener(o,i3[o])},id:n}}var w2=class{__listeners;addEventListener(e,n){this.__listeners===void 0&&(this.__listeners={});let a=this.__listeners;a[e]===void 0&&(a[e]=[]),a[e].indexOf(n)===-1&&a[e].push(n)}hasEventListener(e,n){if(this.__listeners===void 0)return false;let a=this.__listeners;return a[e]!==void 0&&a[e].indexOf(n)!==-1}removeEventListener(e,n){if(this.__listeners===void 0)return;let r=this.__listeners[e];if(r!==void 0){let s=r.indexOf(n);s!==-1&&r.splice(s,1)}}dispatchEvent(e,n){if(this.__listeners===void 0)return;let r=this.__listeners[e.type];if(r!==void 0){n?e.target=n:e.target=this;let s=r.slice(0);for(let i3=0,l=s.length;i3<l;i3++)s[i3].call(this,e)}}};function S2(){}var b2=class extends w2{__listeners={};proxied;style={};width;left;right;top;height;constructor(){super(),this.style={}}get clientWidth(){return this.width}get clientHeight(){return this.height}setPointerCapture=()=>{};releasePointerCapture=()=>{};getBoundingClientRect=()=>({left:this.left,top:this.top,width:this.width,height:this.height,right:this.left+this.width,bottom:this.top+this.height});handleEvent=e=>{e.type==="resize"&&(this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,typeof this.proxied=="object"&&(this.proxied.style.width=this.width+"px",this.proxied.style.height=this.height+"px",this.proxied.clientWidth=this.width,this.proxied.clientHeight=this.height)),e.preventDefault=S2,e.stopPropagation=S2,this.dispatchEvent(e,this.proxied)};focus(){}blur(){}};var g=class{targets={};constructor(){globalThis.document||(globalThis.document={elementFromPoint:(...e)=>this.targets[Object.keys(this.targets)[0]].proxied})}makeProxy=(e,n)=>{e||(e=`proxyReceiver${Math.floor(Math.random()*1e15)}`);let a;this.targets[e]?a=this.targets[e]:(a=new b2,this.targets[e]=a),typeof n=="object"&&(n.proxy=a,a.proxied=n,typeof WorkerGlobalScope<"u"&&(n.style=a.style),a.width&&(n.style.width=a.width+"px",n.clientWidth=a.width),a.height&&(n.style.height=a.height+"px",n.clientHeight=a.height),n.setPointerCapture=a.setPointerCapture.bind(a),n.releasePointerCapture=a.releasePointerCapture.bind(a),n.getBoundingClientRect=a.getBoundingClientRect.bind(a),n.addEventListener=a.addEventListener.bind(a),n.removeEventListener=a.removeEventListener.bind(a),n.handleEvent=a.handleEvent.bind(a),n.dispatchEvent=a.dispatchEvent.bind(a),n.focus=a.focus.bind(a),n.blur=a.blur.bind(a))};getProxy=e=>this.targets[e];handleEvent=(e,n)=>{if(this.targets[n]||this.makeProxy(n),this.targets[n])return this.targets[n].handleEvent(e),true}};function q2(t,e){return this?.__node?.graph?(this.__node.graph.ProxyManager||(this.__node.graph.ProxyManager=new g),this.__node.graph.ProxyManager.makeProxy(t,e)):(globalThis.ProxyManager||(globalThis.ProxyManager=new g),globalThis.ProxyManager.makeProxy(t,e)),t}function M2(t,e){if(this?.__node?.graph){if(this.__node.graph.ProxyManager||(this.__node.graph.ProxyManager=new g),this.__node.graph.ProxyManager.handleEvent(t,e))return t}else if(globalThis.ProxyManager||(globalThis.ProxyManager=new g),globalThis.ProxyManager.handleEvent(t,e))return t}var v={initProxyElement:p,makeProxy:q2,handleProxyEvent:M2};var k2;if(typeof process<"u")try{typeof import_meta<"u"&&(globalThis.__filename=fileURLToPath(import_meta.url),globalThis.__dirname=fileURLToPath(new URL(".",import_meta.url))),k2=F2("path").join(process.cwd(),__dirname,"canvas.worker.js")}catch{}else{let e=globalThis.location.href.split("/");e.pop(),e=e.join("/"),k2=e+"/canvas.worker.js"}var T2=k2;function I2(t){if(t.worker===true&&(t.worker=T2),t.worker){let e=t.worker,n=t.route;return(e instanceof Blob||typeof e=="string")&&(e=new Worker(e)),delete t.worker,delete t.route,N2(e,t,n)}else return p(t.canvas,void 0,t._id,t.preventDefault),V2(t)}function N2(t,e,n){if(!e)return;e._id||(e._id=`canvas${Math.floor(Math.random()*1e15)}`);let a=e.canvas instanceof OffscreenCanvas?e.canvas:e.canvas.transferControlToOffscreen();e.width||(e.width=e.canvas.clientWidth),e.height||(e.height=e.canvas.clientHeight);let r={route:n||"setupCanvas",args:{...e,canvas:a}},s;this?.__node?.graph?s=this.__node.graph.run("initProxyElement",e.canvas,t,e._id,e.preventDefault):s=p(e.canvas,t,e._id,e.preventDefault),e.draw&&(typeof e.draw=="function"?r.args.draw=e.draw.toString():r.args.draw=e.draw),e.update&&(typeof e.update=="function"?r.args.update=e.update.toString():r.args.update=e.update),e.init&&(typeof e.init=="function"?r.args.init=e.init.toString():r.args.init=e.init),e.clear&&(typeof e.clear=="function"?r.args.clear=e.clear.toString():r.args.clear=e.clear);let i3=[a];return e.transfer&&(i3.push(...e.transfer),delete e.transfer),t.postMessage(r,i3),{_id:e._id,width:e.width,height:e.height,worker:t,draw:(o,u)=>{t.postMessage({route:"drawFrame",args:[o,e._id]},u)},update:(o,u)=>{t.postMessage({route:"updateCanvas",args:[o,e._id]},u)},clear:()=>{t.postMessage({route:"clearCanvas",args:e._id})},init:()=>{t.postMessage({route:"initCanvas",args:e._id})},stop:()=>{t.postMessage({route:"stopAnim",args:e._id})},start:()=>{t.postMessage({route:"startAnim",args:e._id})},set:(o,u)=>{t.postMessage({route:"setDraw",args:[o,e._id]},u)},terminate:()=>{s&&s.terminate(),t.terminate()}}}function _(t,e){let n;if(this?.__node?.graph?e?n=this.__node.graph.CANVASES?.[t._id]:t._id?n=this.__node.graph.CANVASES?.[t._id]:n=this.__node.graph.CANVASES?.[Object.keys(this.__node.graph.CANVASES)[0]]:e||t._id?n=globalThis.CANVASES?.[t._id]:n=globalThis.CANVASES?.[Object.keys(globalThis.CANVASES)[0]],n){if(t.canvas){n.canvas=t.canvas,n.proxy&&n.proxy.terminate();let a;this?.__node?.graph?a=this.__node.graph.run("makeProxy",n._id,n.canvas):a=v.makeProxy(n._id,n.canvas),n.proxy=a}return typeof t.context=="string"?n.context=n.canvas.getContext(t.context):t.context&&(n.context=t.context),t.width&&(n.canvas.width=t.width),t.height&&(n.canvas.height=t.height),typeof t.draw=="string"&&(t.draw=f(t.draw)),typeof t.draw=="function"&&(n.draw=t.draw.bind(t)),typeof t.update=="string"&&(t.update=f(t.update)),typeof t.update=="function"&&(n.update=t.update.bind(t)),typeof t.init=="string"&&(t.init=f(t.init)),typeof t.init=="function"&&(n.init=t.init.bind(t)),typeof t.clear=="string"&&(t.clear=f(t.clear)),typeof t.clear=="function"&&(n.clear=t.clear.bind(t)),t._id}}function V2(t){this?.__node?.graph?this.__node.graph.CANVASES||(this.__node.graph.CANVASES={}):globalThis.CANVASES||(globalThis.CANVASES={});let e=t;t._id?e._id=t._id:e._id=`canvas${Math.floor(Math.random()*1e15)}`,typeof t.context=="string"?e.context=t.canvas.getContext(t.context):e.context=t.context,"animating"in t?e.animating=t.animating:e.animating=true;let n;if(this?.__node?.graph?.CANVASES[e._id])this.__node.graph.run("setDraw",e);else if(globalThis.CANVASES?.[e._id])_(e);else{this?.__node?.graph&&(e.graph=this.__node.graph,e.__node||(e.__node={}),e.__node.tag||(e.__node.tag=e._id),e=this.__node.graph.add(e),e.__addOndisconnected=()=>{e.stop(),delete this.__node.graph.CANVASES[e._id]}),this?.__node?.graph?this.__node.graph.CANVASES[e._id]=e:globalThis.CANVASES[e._id]=e,this?.__node?.graph?n=this.__node.graph.run("makeProxy",e._id,e.canvas):n=v.makeProxy(e._id,e.canvas),t.width&&(e.canvas.width=t.width),t.height&&(e.canvas.height=t.height),typeof e.draw=="string"?e.draw=f(e.draw):typeof e.draw=="function"&&(e.draw=e.draw.bind(e)),typeof e.update=="string"?e.update=f(e.update):typeof e.update=="function"&&(e.update=e.update.bind(e)),typeof e.init=="string"?e.init=f(e.init):typeof e.init=="function"&&(e.init=e.init.bind(e)),typeof e.clear=="string"?e.clear=f(e.clear):typeof e.clear=="function"&&(e.clear=e.clear.bind(e));let a=()=>{if(e.stop=()=>{x2(e._id)},e.start=r=>{E(e._id,r)},e.set=r=>{_(r,e._id)},typeof e.draw=="function"&&e.animating){let r=(s,i3,l)=>{if(s.animating){let o=s.draw(s,i3,l);o?.then?o.then(()=>{requestAnimationFrame(()=>{r(s,i3,l)})}):requestAnimationFrame(()=>{r(s,i3,l)})}};r(e,e.canvas,e.context)}if(typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope)return e._id;{let r={_id:t._id,width:t.width,height:t.height,proxy:n,draw:s=>{L2(s,t._id)},update:s=>{R2(s,t._id)},clear:()=>{D2(t._id)},init:()=>{H2(t._id)},stop:()=>{x2(t._id)},start:()=>{E(t._id)},set:s=>{_(s,t._id)},terminate:()=>{r.proxy&&r.proxy.terminate(),this.__node?.graph?this.__node.graph.remove(t._id):(x2(t._id),this?.__node?.graph?delete this.__node.graph.CANVASES[e._id]:delete globalThis.CANVASES[e._id])}};return r}};if(typeof e.init=="function"){let r=e.init(e,e.canvas,e.context);return r?.then?new Promise(s=>{r.then(()=>{s(a())})}):a()}else a()}}function L2(t,e){let n=h.call(this,e);if(n&&(t&&Object.assign(n,t),n.draw))return n.draw(n,n.canvas,n.context),e}function D2(t){let e=h.call(this,t);if(e?.clear)return e.clear(e,e.canvas,e.context),t}function H2(t){let e=h.call(this,t);if(e?.init)return e.init(e,e.canvas,e.context),t}function R2(t,e){let n=h.call(this,e);if(n?.update)return n.update(n,n.canvas,n.context,t),e}function U2(t,e){let n=h.call(this,e);if(n&&t)return Object.assign(n,t),t.width&&(n.canvas.width=t.width),t.height&&(n.canvas.height=t.height),e}function E(t,e){let n=h.call(this,t);if(n.animating=true,n&&e)return typeof e=="string"&&(e=f(e)),typeof e=="function"&&(n.draw=e),t;if(typeof n?.draw=="function"){let a=(r,s,i3)=>{r.animating&&(r.draw(r,s,i3),requestAnimationFrame(()=>{a(r,s,i3)}))};return typeof n.clear=="function"&&n.clear(n,n.canvas,n.context),typeof n.init=="function"&&n.init(n,n.canvas,n.context),a(n,n.canvas,n.context),t}}function x2(t){let e=h.call(this,t);if(e)return e.animating=false,typeof e.clear=="function"&&requestAnimationFrame(e.clear(e,e.canvas,e.context)),t}function h(t){let e;return this?.__node?.graph?t?e=this.__node.graph.CANVASES?.[t]:e=this.__node.graph.CANVASES?.[Object.keys(this.__node.graph.CANVASES)[0]]:t?e=globalThis.CANVASES?.[t]:e=globalThis.CANVASES?.[Object.keys(globalThis.CANVASES)[0]],e}var ne={...v,Renderer:I2,transferCanvas:N2,setupCanvas:V2,setDraw:_,drawFrame:L2,clearCanvas:D2,initCanvas:H2,updateCanvas:R2,setProps:U2,startAnim:E,stopAnim:x2,getCanvas:h};function f(t=""){let e=i3=>i3.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4"),a=(i3=>{let l=i3.indexOf("=>")+1;return l<=0&&(l=i3.indexOf("){")),l<=0&&(l=i3.indexOf(") {")),i3.slice(0,i3.indexOf("{",l)+1)})(t),r=e(t),s;if(a.includes("function")){let i3=a.split("(")[1].split(")")[0];s=new Function(i3,r)}else if(a.substring(0,6)===r.substring(0,6)){let i3=a.split("(")[1].split(")")[0];s=new Function(i3,r.substring(r.indexOf("{")+1,r.length-1))}else try{s=(0,eval)(a+r+"}")}catch{}return s}})();
